<!DOCTYPE html>
<html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        H1 {
            float: left;
            font-family: Helvetica, Arial
        }
        #receiptList {
            clear: both;
            width: 408px;
        }
        .receipt {
            background-color: lightpink;
            width: 100%;
        }

        .receipt span {
            margin: -1px;
            padding: 6px;
            text-align: center;
            width: 90px;
            display: inline-block;
        }

        .table-top {
            background-color: lightpink;
            width: 100%;
        }

        .table-top span {
            margin: -1px;
            padding: 6px;
            text-align: center;
            width: 91px;
            display: inline-block;
        }

        .add-tag {
            text-align: center;
            border-radius: 50px;
            border: 1px solid black;
            cursor: pointer;
            vertical-align: middle;
            width: 100px;
            color: white;
            height: 30px;
            display: inline-table;
            line-height: 30px;
            vertical-align: middle;
            background-color: darkmagenta;
        }

        .tag_input {
            margin-bottom: 5px;
            width: 70px;
            border: 1px solid black;
            background: inherit;

        }

        #input-amount-ui {
            margin-top: -4px;
            margin-bottom: 15px;
            width: 408px;
            border: 1px solid black;
            position: relative;
            display: none;
            background: darkmagenta;
        }
        #input-amount-ui input {
            margin-bottom: 10px;
            margin-left: 22px;
            padding-left: 10px;
            border: 1px solid black;
            font-size: 20px;
            height: 30px;
            width: 88%;
            color: white;
            background: inherit;
        }

        #camera-ui {
            margin-top: -4px;
            margin-bottom: 15px;
            width: 408px;
            border: 1px solid black;
            position: relative;
            display: none;
            background: darkmagenta;
        }
        #camera-ui input {
            margin-bottom: 10px;
            margin-left: 22px;
            padding-left: 10px;
            border: 1px solid black;
            font-size: 20px;
            height: 30px;
            width: 88%;
            color: white;
            background: inherit;
        }

        .button-holder {
            margin-top: 10px;
            margin-bottom: 25px;
            margin-left: 180px;
        }
        #add-receipt {
            display: inline-block;
            cursor: pointer;
            text-align: center;
            border: 1px solid black;
            border-radius: 5px;
            width: 100px;
            height: 30px;
            vertical-align: middle;
            font-size: 30px;
            font-weight: bold;
            color: white;
            background-color: darkmagenta;
        }

        #start-camera {
            display: inline-block;
            cursor: pointer;
            text-align: center;
            border: 1px solid black;
            border-radius: 5px;
            width: 100px;
            height: 30px;
            vertical-align: middle;
            font-size: 30px;
            font-weight: bold;
            color: white;
            background-color: darkmagenta;
        }

        #save-receipt {
            text-align: center;
            font-size: 24px;
            cursor: pointer;
            width: 100px;
            height: 30px;
            vertical-align: middle;
            border-radius: 5px;
            display: inline-table;
            line-height: 50px;
            border: 1px solid black;
            color: white;
            background-color: deeppink;
        }

        #cancel-receipt {
            text-align: center;
            border: 1px solid black;
            font-size: 24px;
            display: inline-table;
            cursor: pointer;
            line-height: 50px;
            vertical-align: middle;
            width: 100px;
            height: 30px;
            border-radius: 5px;
            color: white;
            background-color: darkblue;
        }

        #take-pic {
            text-align: center;
            font-size: 24px;
            cursor: pointer;
            width: 100px;
            height: 30px;
            vertical-align: middle;
            border-radius: 5px;
            display: inline-table;
            line-height: 50px;
            border: 1px solid black;
            color: white;
            background-color: deeppink;
        }

        #take-pic-cancel {
            text-align: center;
            border: 1px solid black;
            font-size: 24px;
            display: inline-table;
            cursor: pointer;
            line-height: 50px;
            vertical-align: middle;
            width: 100px;
            height: 30px;
            border-radius: 5px;
            color: white;
            background-color: darkblue;
        }

        .tagValue {
            margin-bottom: 5px;
            border-radius: 50px;
            border: 1px solid black;
            text-align: center;
            display: inline-table;
            vertical-align: middle;
            line-height: 20px;
            width: 100px;
            height: 30px;
            cursor: pointer;
            color: white;
            background-color: darkblue;
        }

        video {
            width: 300px;
            height: 300px;
            border: 1px solid black;
        }

        #vidwrap {
            margin: 20px 0;
        }

        #start, #snapshot {
            height: 3em;
        }
    </style>

    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function () {
            const api = "http://localhost:8080";
            const receipts_restful_api = api + "/receipts";
            const tags_restful_api = api + "/tags";
            const images_restful_api = api + "/images";
            const application_json = "application/json";
            const tag_x_removal = " x";
            let imageCapture;
            let track;

            $.getJSON(receipts_restful_api, function (receipts) {
                for (var idx = 0; idx < receipts.length; idx++) {
                    addRow(receipts[idx]);
                }
            });

            $('#add-receipt').on('click', function () {
                $('#camera-ui').hide();
                $('#input-amount-ui').show();
            });
            $('#start-camera').on('click', function () {
                $('#input-amount-ui').hide();
                $('#camera-ui').show();
            });
            $('#save-receipt').on('click', function () {
                console.info("save-receipt ");
                var input_json = {
                    merchant: $('#merchant').val(),
                    amount: $('#amount').val()
                };
                $.ajax({
                    url: receipts_restful_api,
                    dataType: 'json',
                    type: 'POST',
                    contentType: application_json,
                    data: JSON.stringify(input_json),
                    success: function (receipt) {
                        console.info("addRow");
                        addRow(receipt);
                        $('#merchant').val('');
                        $('#amount').val('');
                        $('#input-amount-ui').hide();
                    },
                    error: function (jqXhr, textStatus, errorThrown) {
                        console.log(errorThrown);
                    }
                });
            });

            $('#cancel-receipt').on('click', function () {
                console.info("cancel-receipt ");
                $('#merchant').val('');
                $('#amount').val('');
                $('#input-amount-ui').hide();
            });

            $('#take-pic-cancel').on('click', function () {
                console.info("take-pic-cancel ");
                $('#camera-ui').hide();
            });

            $.put = function(url, data, callback, type){
                if ( $.isFunction(data) ){
                    type = type || callback,
                        callback = data,
                        data = {}
                }
                return $.ajax({
                    type: 'PUT',
                    url: url,
                    contentType: type,
                    data: JSON.stringify(data),
                    success: callback,
                    error: function (jqXhr, textStatus, errorThrown) {
                        console.log(errorThrown);
                    }
                });
            };

            function attachMediaStream(mediaStream) {
                $('video')[0].srcObject = mediaStream;
                // Saving the track allows us to capture a photo
                track = mediaStream.getVideoTracks()[0];
                imageCapture = new ImageCapture(track);
            }

            function startVideo() {
                navigator.mediaDevices.getUserMedia({video: {facingMode: {exact: "environment"}}})
                    .then(attachMediaStream)
                    .catch(error => {
                    navigator.mediaDevices.getUserMedia({video: true})
                    .then(attachMediaStream)
                    .catch(error => {
                    console.log('you are fooked');
                    })
                    })
            }
            function takeSnapshot() {
                // create a CANVAS element that is same size as the image
                imageCapture.grabFrame()
                    .then(img => {
                    const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const base64EncodedImageData = canvas.toDataURL('image/png').split(',')[1];
                $.ajax({
                    url: images_restful_api,
                    type: "POST",
                    data: base64EncodedImageData,
                    contentType: "text/plain",
                    success: function (receiptinfo, canvas) {
                        console.info("receiptinfo" + receiptinfo);
                        renderRecommendation(receiptinfo);
                    },
                })
//                    .then(response => {
//                    $('video').after(`<div>got response: <pre>${JSON.stringify(response)}</pre></div>`);
//            })
            .always(() => console.log('request complete'));
                // For debugging, you can uncomment this to see the frame that was captured
                // $('BODY').append(canvas);
            });
            }

            function renderRecommendation(receiptinfo, canvas) {
                $('#camera-ui').hide();
                $('#merchant').val(receiptinfo.merchantName);
                $('#amount').val(receiptinfo.amount);
                $('#input-amount-ui').show();

//                var canvas1=document.createElement('canvas');
//                var ctx1=canvas1.getContext('2d');
//                console.info("receiptinfo.boundingBox[2]" + receiptinfo.boundingBox[2]);
//                console.info("receiptinfo.boundingBox[3]" + receiptinfo.boundingBox[3]);
//                canvas1.width=receiptinfo.boundingBox[2];
//                canvas1.height=receiptinfo.boundingBox[3];
//                // use the extended from of drawImage to draw the
//                // cropped area to the temp canvas
//                canvas1.getContext('2d').drawImage(canvas, receiptinfo.boundingBox[0],receiptinfo.boundingBox[1], receiptinfo.boundingBox[2], receiptinfo.boundingBox[3]);
                //ctx1.getContext('2d').drawImage(canvas,receiptinfo.boundingBox[0],receiptinfo.boundingBox[1],receiptinfo.boundingBox[2],receiptinfo.boundingBox[3],0,0,receiptinfo.boundingBox[2],receiptinfo.boundingBox[3]);

              //  $('BODY').append(canvas1);
            }

            function addRow(receipt) {
                var tagCount = receipt.tags.length;

                manageTagsAndDivs(receipt, tagCount);

                for (var idx = 0; idx < tagCount; idx++) {
                    var tag = $('#' + receipt.id + "sep" + idx);
                    tag.on('click', function () {
                        removeTag(receipt.id, this);
                        tagCount -= 1;
                    });
                }
                $('#' + receipt.id).on('click', function () {
                    var possibleTag = $(`<input type='text' class="tag_input">`);
                    possibleTag.keypress(function(key) {
                        if (key.which === 13) {
                            var exists = false;

                            tagBlobs = possibleTag.siblings();

                            for (var idx = 0; idx < tagBlobs.length; idx++) {
                                if (possibleTag.val() === tagBlobs[idx].textContent.substr(0, tagBlobs[idx].textContent.length - tag_x_removal.length)) {
                                    exists = true;
                                    possibleTag.remove();
                                }
                            }
                            if (!exists) {
                                tagCount += 1;
                                putTag(receipt, possibleTag, tagCount);
                            }
                        }
                    });
                    possibleTag.insertBefore(this);
                })
            }

            function putTag(receipt, possibleTag, tagCount) {
                $.put(tags_restful_api + "/" + possibleTag.val(), receipt.id, storeNewTag(receipt, tagCount, possibleTag) , application_json);
            }

            function storeNewTag(receipt, tagCount, possibleTag) {
                var addBlob = $(`<div id="${receipt.id + "sep" + (tagCount - 1)}" class="tagValue">${possibleTag.val()}${tag_x_removal}</div>`);
                addBlob.insertBefore(possibleTag);
                addBlob.on('click', function () {
                    removeTag(receipt.id, this);
                });
                possibleTag.remove();
            }

            function manageTagsAndDivs(receipt, tagCount) {
                var tagBlob = "";
                var tagCount = receipt.tags.length;
                if (receipt.tags) {
                    for (var idx = 0; idx < tagCount; idx++) {
                        tagBlob += `<div id="${receipt.id + "sep" + idx}" class="tagValue">${receipt.tags[idx]}${tag_x_removal}</div>`;
                    }
                }
                console.info("receipt.merchant " + receipt.merchant);
                console.info("receipt.amount " + receipt.amount);

                $(`<div class="receipt"><span class="time">${timeSince(receipt.time)}</span><span class="merchant">${receipt.merchant}</span><span class="amount">${parseFloat(receipt.amount).toFixed(2)}</span><span class="tags">${tagBlob}<div id="${receipt.id}" class="add-tag">Add +</div></span></div>`)
                    .appendTo($("#receiptList"));
            }

            function removeTag(receiptId, tag) {
                console.info("removeTag " + tag);
                $.put(tags_restful_api + "/" + tag.innerText.slice(0, -tag_x_removal.length), receiptId, function() {
                    tag.remove();
                }, application_json);
            }

            function timeSince(timeStamp) {
                var now = new Date();
                var secondsPast = (now.getTime() - timeStamp) / 1000;
                var ago = " ago";
                if(secondsPast < 60){
                    return parseInt(secondsPast) + " s" + ago;
                }
                if(secondsPast < 3600){
                    return parseInt(secondsPast/60) + " m"+ ago;
                }
                if(secondsPast <= 86400){
                    return parseInt(secondsPast/3600) + " h"+ ago;
                }
                if(secondsPast > 86400){
                    var formatTime = new Date(timeStamp);
                    day = formatTime.getDate();
                    month = formatTime.toDateString().match(/ [a-zA-Z]*/)[0].replace(" ","");
                    year = formatTime.getFullYear() == now.getFullYear() ? "" :  " " + formatTime.getFullYear();
                    return day + " " + month + year + ago;
                }
            }


            $(function () {
                $('#start-camera').on('click', startVideo);
                $('video').on('play', () => $('#take-pic').prop('disabled', false));
                $('#take-pic').on('click', takeSnapshot);
            });

            //<img src="snap.png" height="30"/>

            $(`<div class="table-top"><span>Time</span><span>Merchant</span><span>$</span><span>Tags</span></div>`)
                .appendTo($("#receiptList"))
        })
    </script>
</head>

<body>
<div id="container">
    <h1>My Receipts</h1>
    <div id="add-receipt">+</div>
    <div id="start-camera">camera</div>
    <div id="input-amount-ui">
        <input id="merchant" type="text" placeholder="merchant">
        <input id="amount" type="number" placeholder="amount">
        <div class="button-holder">
            <div id="cancel-receipt">cancel</div>
            <div id="save-receipt">save</div>
        </div>
    </div>
    <div id="camera-ui">
        <div id="vidwrap">
            <video autoplay></video>
        </div>
        <div class="button-holder">
            <div id="take-pic-cancel">cancel</div>
            <div id="take-pic" disabled="true">snap</div>
        </div>
    </div>
    <div id="receiptList"></div>
</div>
</body>
</html>